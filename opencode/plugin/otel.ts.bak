import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-grpc";
import {
  BatchSpanProcessor,
  ConsoleSpanExporter,
  SimpleSpanProcessor,
  type SpanProcessor,
} from "@opentelemetry/sdk-trace-base";
import { NodeSDK } from "@opentelemetry/sdk-node";

let initialized = false;

export const OtelPlugin = async () => ({
  async config(config) {
    if (initialized) return;
    initialized = true;
    const processor = new SimpleSpanProcessor(new OTLPTraceExporter());
    new NodeSDK({ spanProcessors: [processor] }).start();
    // Flush frequently - Required in headless mode to make sure flushes are made before process exit
    setInterval(() => processor.forceFlush(), 500);
  },
});
